@* // =================================================================
// SECTION 1: DIRECTIVES (Instructions for Blazor)
// =================================================================

// This MUST be the first line. It tells Blazor this is a page with the URL "/members".
 *@
 @page "/members"

@*  // This tells the page where to find your auto-generated data classes (like the Member class).
  // *** Replace "YourProjectName" with the actual name of your project. *** *@
@using AIX.Admin.Web.Data

@*// This asks Blazor to "inject" or provide the database connection service.
// *** Replace "YourDbContext" with the actual name of your DbContext file. ***  *@
@inject AppDbContext DbContext

@*
// =================================================================
// SECTION 2: HTML & MUD BLazor COMPONENTS (What the user sees)
// =================================================================
*@
<MudText Typo="Typo.h4">Church Members</MudText>



@* // This logic checks if the data has been loaded from the database yet. 
@if (memberList == null)
{
    // If 'memberList' is null, it means we're still loading, so show a spinner.
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
*@    <MudPaper Class="pa-4 mb-4">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="searchLastName" Label="Last Name" Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="searchFirstName" Label="First Name" Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="searchEmail" Label="Email" Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="searchZipCode" Label="Zip Code" Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="12" Class="d-flex justify-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FilterMembers" Class="mr-2">Search</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilter">Clear</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
    
    // Once 'memberList' has data, show the MudTable grid.
    <MudTable Items="@filteredMemberList" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>First Name</MudTh>
            <MudTh>Last Name</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="First Name">@context.FirstName</MudTd>
            <MudTd DataLabel="Last Name">@context.LastName</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>


@*
// =================================================================
// SECTION 3: C# LOGIC (The page's "brain")
// =================================================================
*@

@code {
    // This list holds ALL members from the database and never changes.
    private List<Member> allMembers;

    // This list holds the members to be displayed in the table (after filtering).
    private List<Member> filteredMemberList = new List<Member>();

    // Variables to hold the text from our search boxes.
    private string searchLastName = "";
    private string searchFirstName = "";
    private string searchEmail = "";
    private string searchZipCode = "";

    public Members(List<Member> allMembers)
    {
        this.allMembers = allMembers;
    }

    protected override async Task OnInitializedAsync()
    {
        // 1. Load all members from the database into our master list.
        allMembers = await DbContext.Members.ToListAsync();

        // 2. Initially, the filtered list is the same as the master list.
        filteredMemberList = allMembers;
    }

    private void FilterMembers()
    {
        // Start with the full list of members.
        var query = allMembers.AsQueryable();

        // Apply filters one by one, only if the search box has text.
        if (!string.IsNullOrWhiteSpace(searchLastName))
        {
            query = query.Where(m => m.LastName != null && m.LastName.Contains(searchLastName, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(searchFirstName))
        {
            query = query.Where(m => m.FirstName != null && m.FirstName.Contains(searchFirstName, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(searchEmail))
        {
            query = query.Where(m => m.EmailAdr != null && m.EmailAdr.Contains(searchEmail, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(searchZipCode))
        {
            query = query.Where(m => m.ZipCode != null && m.ZipCode.ToString().Contains(searchZipCode, StringComparison.OrdinalIgnoreCase));
        }

        // Update the list that the table is bound to. The UI will refresh automatically.
        filteredMemberList = query.ToList();
    }

    private void ClearFilter()
    {
        // Clear the search boxes.
        searchLastName = "";
        searchFirstName = "";
        searchEmail = "";
        searchZipCode = "";

        // Reset the filtered list back to the full master list.
        filteredMemberList = allMembers;
    }
}