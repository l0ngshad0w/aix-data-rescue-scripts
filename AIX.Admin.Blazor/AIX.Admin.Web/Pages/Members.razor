@page "/members"
@using AIX.Admin.Web.Data.Entities
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DbContext
<button class="btn btn-primary">TEST - If this is blue, Bootstrap works</button>

<div class="container-fluid mt-3" @onkeydown="HandleGlobalKeyPress" @onkeydown:preventDefault="false" tabindex="-1">
    <div class="row">
        <div class="col-12">
            <h3>Member Search</h3>
            <p class="text-muted">Debug: focusedRowIndex = @focusedRowIndex, searchExecuted = @searchExecuted, resultCount = @filteredMembers.Count</p>
        </div>
    </div>

    @* Search Form *@
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form @onsubmit="SearchMembers" @onsubmit:preventDefault>
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label">Last Name</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="searchLastName"
                                       @ref="lastNameInput"
                                       tabindex="1"
                                       placeholder="Enter last name" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">First Name</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="searchFirstName"
                                       tabindex="2"
                                       placeholder="Enter first name" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Email</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="searchEmail"
                                       tabindex="3"
                                       placeholder="Enter email" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Zip Code</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="searchZipCode"
                                       tabindex="4"
                                       placeholder="Enter zip" />
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary" tabindex="5">
                                    Search (Enter)
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" @onclick="ClearSearch" tabindex="6">
                                    Clear (Esc)
                                </button>
                                <span class="ms-3 text-muted">
                                    @if (searchExecuted)
                                    {
                                        <text>Found @filteredMembers.Count members</text>
                                    }
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @* Results Table *@
    @if (searchExecuted && filteredMembers.Any())
    {
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6;"
                             tabindex="0"
                             @onkeydown="HandleTableKeyPress"
                             @ref="tableContainer">
                            <table class="table table-sm table-hover mb-0" style="margin: 0;">
                                <thead style="position: sticky; top: 0; z-index: 10; background-color: #343a40;">
                                    <tr>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">Member #</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">Last Name</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">First Name</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">City</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">State</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">Zip</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">Email</th>
                                        <th style="color: white; padding: 12px; border-bottom: 2px solid #495057;">Ordination Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var (member, index) in filteredMembers.Take(100).Select((m, i) => (m, i)))
                                    {
                                        <tr @onclick="() => SelectMemberByIndex(index)"
                                            style="@GetRowStyle(index)">
                                            <td style="padding: 8px;">@member.MemberNo</td>
                                            <td style="padding: 8px;">@member.LastName</td>
                                            <td style="padding: 8px;">@member.FirstName</td>
                                            <td style="padding: 8px;">@member.City</td>
                                            <td style="padding: 8px;">@member.State</td>
                                            <td style="padding: 8px;">@member.ZipCode</td>
                                            <td style="padding: 8px;">@member.EmailAdr</td>
                                            <td style="padding: 8px;">@(member.OrdinDate?.ToString("MM/dd/yyyy") ?? "")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (filteredMembers.Count > 100)
                        {
                            <div class="alert alert-info m-2">
                                Showing first 100 of @filteredMembers.Count results. Refine your search for more specific results.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
else if (searchExecuted && !filteredMembers.Any())
    {
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-warning">
                    No members found matching your search criteria.
                </div>
            </div>
        </div>
    }

    @* Selected Member Details *@
    @if (selectedMember != null)
    {
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Selected Member Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Member #:</strong> @selectedMember.MemberNo</p>
                                <p><strong>Name:</strong> @selectedMember.FirstName @selectedMember.MiddleName @selectedMember.LastName</p>
                                <p><strong>Address:</strong> @selectedMember.Address1 @selectedMember.Address2</p>
                                <p><strong>City/State/Zip:</strong> @selectedMember.City, @selectedMember.State @selectedMember.ZipCode</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Email:</strong> @selectedMember.EmailAdr</p>
                                <p><strong>Phone:</strong> (@selectedMember.AreaCode) @selectedMember.PhoneNo</p>
                                <p><strong>Ordination Date:</strong> @(selectedMember.OrdinDate?.ToString("MM/dd/yyyy") ?? "N/A")</p>
                                <p><strong>Last Modified:</strong> @selectedMember.LastModifiedDttm.ToString("MM/dd/yyyy")</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary me-2" @onclick="EditMember">Edit Member (Alt+E)</button>
                                <button class="btn btn-secondary" @onclick="() => selectedMember = null">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private ElementReference lastNameInput;
    private ElementReference tableContainer; // Reference to the table div
    private int focusedRowIndex = -1;  // Which row has keyboard focus (-1 = none)
    private string searchLastName = "";
    private string searchFirstName = "";
    private string searchEmail = "";
    private string searchZipCode = "";

    private List<Member> filteredMembers = new();
    private Member? selectedMember = null;
    private bool searchExecuted = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await lastNameInput.FocusAsync();
        }
    }

    private async Task SearchMembers()
    {
        if (string.IsNullOrWhiteSpace(searchLastName) &&
            string.IsNullOrWhiteSpace(searchFirstName) &&
            string.IsNullOrWhiteSpace(searchEmail) &&
            string.IsNullOrWhiteSpace(searchZipCode))
        {
            return;
        }

        var query = DbContext.Members.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchLastName))
        {
            query = query.Where(m => m.LastName != null && m.LastName.Contains(searchLastName));
        }

        if (!string.IsNullOrWhiteSpace(searchFirstName))
        {
            query = query.Where(m => m.FirstName != null && m.FirstName.Contains(searchFirstName));
        }

        if (!string.IsNullOrWhiteSpace(searchEmail))
        {
            query = query.Where(m => m.EmailAdr != null && m.EmailAdr.Contains(searchEmail));
        }

        if (!string.IsNullOrWhiteSpace(searchZipCode))
        {
            query = query.Where(m => m.ZipCode !=null && m.ZipCode.ToString()!.Contains(searchZipCode));
        }

        filteredMembers = await query
            .OrderBy(m => m.LastName)
            .ThenBy(m => m.FirstName)
            .Take(500)
            .ToListAsync();

        searchExecuted = true;
        selectedMember = null;
        focusedRowIndex = 0; // Focus first row

        //Focus the table so arrow keys work immediately
        StateHasChanged(); 
        await Task.Delay(50); // Slight delay to ensure rendering is complete
        await tableContainer.FocusAsync();
    }

    private void ClearSearch()
    {
        searchLastName = "";
        searchFirstName = "";
        searchEmail = "";
        searchZipCode = "";
        filteredMembers.Clear();
        selectedMember = null;
        searchExecuted = false;
    }

    private void SelectMember(Member member)
    {
        selectedMember = member;
    }

    private async Task HandleTableKeyPress(KeyboardEventArgs e)
    {

        // Get the currently displayed results (limited to 100)
        var displayedResults = filteredMembers.Take(100).ToList();

        if (!displayedResults.Any()) return;

        switch (e.Key)
        {
            case "ArrowDown":
                // If no row is focused, focus the first row
                if (focusedRowIndex < 0)
                {
                    focusedRowIndex = 0;
                }
                // Otherwise move down, wrapping to top if at bottom
                else if (focusedRowIndex < displayedResults.Count - 1)
                {
                    focusedRowIndex++;
                }
                else
                {
                    focusedRowIndex = 0;
                }
                // auto select as you arrow
                SelectMemberByIndex(focusedRowIndex);
                break;

            case "ArrowUp":
                // If no row focused yet, start at last row
                if (focusedRowIndex < 0)
                {
                    focusedRowIndex = displayedResults.Count - 1;
                }
                // Otherwise move up, wrapping to bottom if at top
                else if (focusedRowIndex > 0)
                {
                    focusedRowIndex--;
                }
                else
                {
                    focusedRowIndex = displayedResults.Count - 1; // Wrap to bottom
                }
                SelectMemberByIndex(focusedRowIndex);
                break;

            case "Enter":
                if (focusedRowIndex >= 0 && focusedRowIndex < displayedResults.Count)
                {
                    SelectMemberByIndex(focusedRowIndex);
                }
                break;

            case "Escape":
                // Clear selection and reset focus
                selectedMember = null;
                focusedRowIndex = -1;
                break;
        }

        //Prevent default browser behavior (like scrolling)
        await Task.CompletedTask;

    }

    //Select a member by their index in the displayed results
    private void SelectMemberByIndex(int index)
    {
        var displayedResults = filteredMembers.Take(100).ToList();
        if (index >= 0 && index < displayedResults.Count)
        {
            SelectMember(displayedResults[index]);
            focusedRowIndex = index;
        }
    }

    //Determine CSS class for a row (handles both selection and focus)
    private string GetRowClass(int index)
    {
        var classes = new List<string>();

        var displayedResults = filteredMembers.Take(100).ToList();

        // Check if this row's member is selected
        if (index < displayedResults.Count &&
            selectedMember != null &&
            displayedResults[index].MemberPkId == selectedMember.MemberPkId)
        {
            classes.Add("row-selected");
        }

        // Check if this row has keyboard focus
        if (index == focusedRowIndex)
        {
            classes.Add("row-focused");
        }

        return string.Join(" ", classes);
    }

    private string GetRowStyle(int index)
    {
        var displayedResults = filteredMembers.Take(100).ToList();
        var styles = new List<string>();

        // Always add cursor pointer
        styles.Add("cursor: pointer");
        styles.Add("padding: 8px");

        // Check if this row is selected
        bool isSelected = selectedMember != null &&
                          index < displayedResults.Count &&
                          displayedResults[index].MemberPkId == selectedMember.MemberPkId;

        // Check if this row has keyboard focus
        bool isFocused = index == focusedRowIndex;

        // Both selected AND focused - PURPLE
        if (isSelected && isFocused)
        {
            styles.Add("background-color: #6f42c1");
            styles.Add("color: white");
            styles.Add("border-left: 6px solid #ffc107");
            styles.Add("font-weight: 500");
        }
        // Just selected - BLUE
        else if (isSelected)
        {
            styles.Add("background-color: #0d6efd");
            styles.Add("color: white");
            styles.Add("border-left: 4px solid #0a58ca");
        }
        // Just focused - PINK (temp test)
        else if (isFocused)
        {
            styles.Add("background-color: #ff1493");  // Deep pink
            styles.Add("color: white"); // Ensure text is readable
            styles.Add("border-left: 6px solid #ffd700"); // Gold border
            styles.Add("font-weight: 500");
        }

        return string.Join("; ", styles);
    }

    private void HandleGlobalKeyPress(KeyboardEventArgs e)
    {
        //Alt+E = Edit selected member
        if (e.AltKey && e.Key.ToLower() == "e" && selectedMember != null)
        {
            // Implement edit logic here
            EditMember();
        }
        // Alt+N = New member for future
        if (e.AltKey && e.Key == "n")
        {
            //TODO: Navigate to new member page
        }
        else

        // Escape = Close detail panel
        if (e.Key == "Escape")
        {
            selectedMember = null;
            focusedRowIndex = -1;
        }
    }

    private void EditMember()
    {
        if (selectedMember == null) return;

        // For now, just show an alert
        //Later, we'll navigate to an edit page
        //NavigationManager.NavigateTo($"/members/edit/{selectedMember.MemberNo}");

        // TODO:  Implement edit functionality
        Console.WriteLine($"Editing member {selectedMember.FirstName} {selectedMember.LastName}"); 
    }
}