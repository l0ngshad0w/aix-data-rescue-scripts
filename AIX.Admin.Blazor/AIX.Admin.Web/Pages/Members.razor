@page "/members"
@using AIX.Admin.Web.Data.Entities
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DbContext
@inject NavigationManager Navigation

<div class="container-fluid mt-3" @onkeydown="HandleGlobalKeyPress" tabindex="-1">
    <div class="row">
        <div class="col-12">
            <h3>Member Search & Edit</h3>
        </div>
    </div>

    @* Primary Data Entry Form *@
    <div class="row mt-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header" style="background-color: #343a40; color: white;">
                    <strong>Member Information</strong>
                    @if (currentMember != null)
                    {
                        <span class="float-end">Member #@currentMember.MemberNo</span>
                    }
                </div>
                <div class="card-body">
                    <form @onsubmit="SearchMembers" @onsubmit:preventDefault>
                        @* Row 1: Zip + Last Name *@
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Zip Code</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editZipCode"
                                       @ref="zipCodeInput"
                                       tabindex="1"
                                       maxlength="5"
                                       placeholder="Enter zip" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">+Ext</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editZipExt"
                                       tabindex="2"
                                       maxlength="4"
                                       disabled="@(!isEditing)" />
                            </div>
                            <div class="col-md-7">
                                <label class="form-label fw-bold">Last Name</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="searchLastName"
                                       tabindex="3"
                                       maxlength="40"
                                       placeholder="Enter last name" />
                            </div>
                        </div>

                        @* Row 2: First + Middle *@
                        <div class="row mb-2">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">First Name</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editFirstName"
                                       tabindex="4"
                                       maxlength="40" />
                                       @* disabled="false" *@
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Middle</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editMiddleName"
                                       tabindex="5"
                                       maxlength="40"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 3: Address 1 *@
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Address 1</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editAddress1"
                                       tabindex="6"
                                       maxlength="100"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 4: Address 2 *@
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Address 2</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editAddress2"
                                       tabindex="7"
                                       maxlength="80"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 5: City + State *@
                        <div class="row mb-2">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">City</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editCity"
                                       tabindex="8"
                                       maxlength="60"
                                       disabled="@(!isEditing)" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">State</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editState"
                                       tabindex="9"
                                       maxlength="10"
                                       style="text-transform: uppercase;"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 6: Email *@
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Email</label>
                                <input type="email"
                                       class="form-control"
                                       @bind="editEmail"
                                       tabindex="10"
                                       maxlength="120"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 7: Phone *@
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Area Code</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editAreaCode"
                                       tabindex="11"
                                       maxlength="10"
                                       placeholder="(209)"
                                       disabled="@(!isEditing)" />
                            </div>
                            <div class="col-md-9">
                                <label class="form-label fw-bold">Phone Number</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="editPhoneNo"
                                       tabindex="12"
                                       maxlength="20"
                                       disabled="@(!isEditing)" />
                            </div>
                        </div>

                        @* Row 8: Ordination Date *@
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Ordination Date</label>
                                <input type="date"
                                       class="form-control"
                                       @bind-value="editOrdinDate"
                                       tabindex="13"
                                       disabled="@(!isEditing)" />
                            </div>
                            @if (showMoreFields)
                            {
                                <div class="col-md-4">
                                    <label class="form-label">Subscription Date</label>
                                    <input type="date"
                                           class="form-control"
                                           @bind-value="editSubscrDate"
                                           tabindex="14"
                                           disabled="@(!isEditing)" />
                                </div>
                            }
                        </div>

                        @* Additional Fields (shown when F4 pressed) *@
                        @if (showMoreFields)
                        {
                            <div class="row mb-2" style="border-top: 2px solid #dee2e6; padding-top: 1rem;">
                                <div class="col-md-6">
                                    <label class="form-label">Congregation 1</label>
                                    <input type="text"
                                           class="form-control"
                                           @bind="editCongrNum1"
                                           tabindex="15"
                                           disabled="@(!isEditing)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Congregation 2</label>
                                    <input type="text"
                                           class="form-control"
                                           @bind="editCongrNum2"
                                           tabindex="16"
                                           disabled="@(!isEditing)" />
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-12">
                                    <label class="form-label">Foreign Address</label>
                                    <input type="text"
                                           class="form-control"
                                           @bind="editForeignAddress"
                                           tabindex="17"
                                           maxlength="120"
                                           disabled="@(!isEditing)" />
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="form-check-input"
                                               @bind="editSameAdr"
                                               tabindex="18"
                                               id="sameAdrCheck"
                                               disabled="@(!isEditing)" />
                                        <label class="form-check-label" for="sameAdrCheck">
                                            Same Address (use congregation)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        }

                        @* Buttons *@
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary" tabindex="19">
                                    Search (F2)
                                </button>
                                <button type="button" class="btn btn-success ms-2" @onclick="NewMember" tabindex="20">
                                    New (F3)
                                </button>
                                <button class="btn btn-info me-2" @onclick="ManageCertificates">
                                    Manage Certificates (F4)
                                </button>
                                <button type="button"
                                        class="btn btn-warning ms-2"
                                        @onclick="SaveMember"
                                        tabindex="21"
                                        disabled="@(!isEditing || currentMember == null)">
                                    Save (Alt+S)
                                </button>
                                <button type="button"
                                        class="btn btn-secondary ms-2"
                                        @onclick="ToggleMoreFields"
                                        tabindex="22">
                                    @(showMoreFields ? "Less" : "More...") (F8)
                                </button>
                                <button type="button" 
                                    class="btn btn-outline-secondary ms-2"
                                        @onclick="ClearScreen"
                                    tabindex="23">
                                    Clear (Esc)
                                </button>

                                @if (!string.IsNullOrEmpty(statusMessage))
                                {
                                    <span class="ms-3 @statusMessageClass">@statusMessage</span>
                                }
                            </div>
                        </div>
                    </form>
                </div>
                @if (currentMember != null)
                {
                    <div class="card-footer text-muted" style="font-size: 0.875rem;">
                        Last Modified: @currentMember.LastModifiedDttm.ToString("MM/dd/yyyy HH:mm")
                    </div>
                }
            </div>
        </div>

        @* Search Results Panel *@
        <div class="col-md-4">
            @if (searchResults.Any())
            {
                <div class="card">
                    <div class="card-header" style="background-color: #6c757d; color: white;">
                        <strong>Search Results (@searchResults.Count found)</strong>
                    </div>
                    <div class="card-body p-0">
                        <div style="max-height: 600px; overflow-y: auto;"
                             tabindex="0"
                             @onkeydown="HandleResultsKeyPress"
                             @ref="resultsContainer">
                            <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                                <tbody>
                                    @foreach (var (member, index) in searchResults.Select((m, i) => (m, i)))
                                    {
                                        <tr @onclick="() => SelectMember(index)"
                                            style="@GetResultRowStyle(index); cursor: pointer;">
                                            <td style="padding: 6px;">
                                                <strong>@member.MemberNo</strong><br />
                                                @member.LastName, @member.FirstName<br />
                                                <small class="text-muted">@member.City, @member.State @member.ZipCode</small>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {

    // Query parameters
    [SupplyParameterFromQuery(Name = "selectMember")]
    public int? SelectMemberNo { get; set; }

    // Element references
    private ElementReference zipCodeInput;
    private ElementReference resultsContainer;

    // Search fields
    // private string searchZipCode = "";
    private string searchLastName = "";

    // Edit fields (bound to form)
    private string editZipCode = ""; // <-- FIX: Add missing declaration
    private string editZipExt = "";
    private string editFirstName = "";
    private string editMiddleName = "";
    private string editAddress1 = "";
    private string editAddress2 = "";
    private string editCity = "";
    private string editState = "";
    private string editEmail = "";
    private string editAreaCode = "";
    private string editPhoneNo = "";
    private DateOnly? editOrdinDate = null;
    private DateOnly? editSubscrDate = null;
    private string editCongrNum1 = "";
    private string editCongrNum2 = "";
    private string editForeignAddress = "";
    private bool editSameAdr = false;


    // State
    private List<Member> searchResults = new();
    private Member? currentMember = null;
    private int focusedResultIndex = -1;
    private bool isEditing = false;
    private bool showMoreFields = false;
    private string statusMessage = "";
    private string statusMessageClass = "";

    protected override async Task OnInitializedAsync()
    {
        // If returning from certificates page, auto-select member
        if (SelectMemberNo.HasValue)
        {
            editZipCode = "";
            searchLastName = "";

            var member = await DbContext.Members
                .FirstOrDefaultAsync(m => m.MemberNo == SelectMemberNo.Value);

            if (member != null)
            {
                searchResults = new List<Member> { member };
                SelectMember(0);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await zipCodeInput.FocusAsync();
        }
    }

    private async Task SearchMembers()
    {
        var query = DbContext.Members.AsQueryable();
        bool hasSearchCriteria = false;

        //ZipCode search
        if (!string.IsNullOrWhiteSpace(editZipCode))
        {
            if (int.TryParse(editZipCode, out int zip))
            {
                query = query.Where(m => m.ZipCode == zip);
                hasSearchCriteria = true;
            }
        }
        //LastName search
        if (!string.IsNullOrWhiteSpace(searchLastName))
        {
            query = query.Where(m => m.LastName != null && m.LastName.Contains(searchLastName));
            hasSearchCriteria = true;
        }

        //FirstName search
        if (!string.IsNullOrWhiteSpace(editFirstName))
        {
            query = query.Where(m => m.FirstName != null && m.FirstName.Contains(editFirstName));
            hasSearchCriteria = true;
        }

        if(!hasSearchCriteria)
        {
            StatusMessage("Enter search criteria", "text-warning");
            return;
        }

        searchResults = await query
            .OrderBy(m => m.ZipCode)
            .ThenBy(m => m.LastName)
            .ThenBy(m => m.FirstName)
            .Take(100)
            .ToListAsync();

        // Auto-select first result if only one found
        if (searchResults.Count == 1)
        {
            SelectMember(0);
        }
        else if (searchResults.Count > 1)
        {
            focusedResultIndex = 0;
        }

        StatusMessage($"Found {searchResults.Count} members", "text-info");

        //Auto-focus results if multiple found
        if (searchResults.Count > 1)
        {
            _ = FocusResultsAfterRender();  // Fire and forget
        }
    }

    private void SelectMember(int index)
    {
        if (index < 0 || index >= searchResults.Count) return;

        currentMember = searchResults[index];
        focusedResultIndex = index;
        isEditing = true;

        // Populate form fields
        editZipCode = currentMember.ZipCode?.ToString() ?? "";
        editZipExt = currentMember.ZipExt?.ToString() ?? "";
        editFirstName = currentMember.FirstName ?? "";
        editMiddleName = currentMember.MiddleName ?? "";
        editAddress1 = currentMember.Address1 ?? "";
        editAddress2 = currentMember.Address2 ?? "";
        editCity = currentMember.City ?? "";
        editState = currentMember.State ?? "";
        editEmail = currentMember.EmailAdr ?? "";
        editAreaCode = currentMember.AreaCode ?? "";
        editPhoneNo = currentMember.PhoneNo ?? "";
        editOrdinDate = currentMember.OrdinDate;
        editSubscrDate = currentMember.SubscrDate;
        editCongrNum1 = currentMember.CongrNum?.ToString() ?? "";
        editCongrNum2 = currentMember.CongrNum2?.ToString() ?? "";
        editForeignAddress = currentMember.ForeignAddress ?? "";
        editSameAdr = currentMember.SameAdr == 1;

        StatusMessage("", "");
    }

    private async Task NewMember()
    {

        // Get the next available MemberNo
        var maxMemberNo = await DbContext.Members.MaxAsync(m => (int?)m.MemberNo) ?? 0;

        var nextMemberNo = maxMemberNo + 1;

        // Create new member with default values
        currentMember = new Member
                {
                    MemberNo = nextMemberNo,
                    ZipCode = int.TryParse(editZipCode, out int zip) ? zip : null,
                    LastName = searchLastName,
                    FirstName = editFirstName,
                    LastModifiedDttm = DateTime.Now
                };


        isEditing = true;

        // Pre-fill zip if searched by Zip
        if (!string.IsNullOrWhiteSpace(editZipCode))
        {
            // Keep the zip in the form
        }
        else
        {
            editZipCode = "";
        }

        // Clear other fields for new entry
        editZipExt = "";
        editMiddleName = "";
        editAddress1 = "";
        editAddress2 = "";
        editCity = "";
        editState = "";
        editEmail = "";
        editAreaCode = "";
        editPhoneNo = "";
        editOrdinDate = null;
        editSubscrDate = null;
        editCongrNum1 = "";
        editCongrNum2 = "";
        editForeignAddress = "";
        editSameAdr = false;

        //Clear results
        searchResults.Clear();

        StatusMessage($"Creating new member #{nextMemberNo}...", "text-primary");

    }



    private void ClearScreen()
    {
        // Clear search fields
        editZipCode = "";
        searchLastName = "";
        editFirstName = "";

        // Clear results
        searchResults.Clear();

        // Clear current member
        currentMember = null;
        isEditing = false;
        focusedResultIndex = -1;

        //Clear all edit fields
        ClearEditFields();

        // Clear status message
        StatusMessage("Screen cleared", "text-secondary");
    }

    private async Task SaveMember()
    {
        if (currentMember == null) return;

        try
        {
            // Map form fields back to member object
            currentMember.ZipCode = int.TryParse(editZipCode, out int zip) ? zip : null;
            currentMember.ZipExt = short.TryParse(editZipExt, out short zipExt) ? zipExt : null;
            currentMember.FirstName = editFirstName;
            currentMember.MiddleName = editMiddleName;
            currentMember.LastName = searchLastName;
            currentMember.Address1 = editAddress1;
            currentMember.Address2 = editAddress2;
            currentMember.City = editCity;
            currentMember.State = editState;
            currentMember.EmailAdr = editEmail;
            currentMember.AreaCode = editAreaCode;
            currentMember.PhoneNo = editPhoneNo;
            currentMember.OrdinDate = editOrdinDate;
            currentMember.SubscrDate = editSubscrDate;
            currentMember.CongrNum = int.TryParse(editCongrNum1, out int congr1) ? congr1 : null;
            currentMember.CongrNum2 = int.TryParse(editCongrNum2, out int congr2) ? congr2 : null;
            currentMember.ForeignAddress = editForeignAddress;
            currentMember.SameAdr = (short)(editSameAdr ? 1 : 0);
            currentMember.LastModifiedDttm = DateTime.Now;

            // Check if this is a new member (no PK assinged yet)
            if (currentMember.MemberPkId == 0)
            {
                if (string.IsNullOrWhiteSpace(currentMember.LastName))
                {
                    StatusMessage("Last Name is required", "text-danger");
                    return;

                }

                //Check if member_no already exists (safety check)
                var exists = await DbContext.Members
                    .AnyAsync(m => m.MemberNo == currentMember.MemberNo);

                if (exists)
                {
                    StatusMessage($"Error: Member #{currentMember.MemberNo} already exists", "text-danger");
                    return;
                }

                DbContext.Members.Add(currentMember);
                StatusMessage($"✓ New member #{currentMember.MemberNo} created successfully", "text-success");

            }
            else
            {
                // Existing member - update
                StatusMessage(" ✓ Member updated successfully", "text-success"); 
            }

            await DbContext.SaveChangesAsync();

            // Auto-clear message after 3 seconds
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                StatusMessage("", "");
            });

        }
        catch (Exception ex)
        {
            StatusMessage($"Error: {ex.Message}", "text-danger");
        }
    }

    private void ManageCertificates()
    {
        if (currentMember == null) return;
        Navigation.NavigateTo($"/members/{currentMember.MemberNo}/certificates");
    }

    private void HandleResultsKeyPress(KeyboardEventArgs e)
    {
        if (!searchResults.Any()) return;

        switch (e.Key)
        {
            case "ArrowDown":
                if (focusedResultIndex < searchResults.Count - 1)
                {
                    focusedResultIndex++;
                    SelectMember(focusedResultIndex);
                }
                break;
            case "ArrowUp":
                if (focusedResultIndex > 0)
                {
                    focusedResultIndex--;
                    SelectMember(focusedResultIndex);
                }
                break;
        }
    }

    private void HandleGlobalKeyPress(KeyboardEventArgs e)
    {
        // F2 = Search
        if (e.Key == "F2")
        {
            SearchMembers();
        }
        // F3 = New
        else if (e.Key == "F3")
        {
            NewMember();
        }
        // F4 = Manage Certificates
        else if (e.Key == "F4" && currentMember != null)
        {
            ManageCertificates();
        }
        // F8  = Toggle More Fields
        else if (e.Key == "F8")
        {
            ToggleMoreFields();
        }
        // Alt+S = Save
        else if (e.AltKey && e.Key == "s")
        {
            SaveMember();
        }
        // Esc = Clear
        else if (e.Key == "Escape")
        {
            ClearScreen();
        }
    }

    private void ToggleMoreFields()
    {
        showMoreFields = !showMoreFields;
    }

    private void ClearEditFields()
    {
        editZipCode = "";
        editZipExt = "";
        editFirstName = "";
        editMiddleName = "";
        editAddress1 = "";
        editAddress2 = "";
        editCity = "";
        editState = "";
        editEmail = "";
        editAreaCode = "";
        editPhoneNo = "";
        editOrdinDate = null;
        editSubscrDate = null;
        editCongrNum1 = "";
        editCongrNum2 = "";
        editForeignAddress = "";
        editSameAdr = false;
    }

    private void StatusMessage(string message, string cssClass)
    {
        statusMessage = message;
        statusMessageClass = cssClass;
    }

    private string GetResultRowStyle(int index)
    {
        var styles = new List<string> { "cursor: pointer" };

        if (index == focusedResultIndex)
        {
            styles.Add("background-color: #fff3cd");
            styles.Add("border-left: 4px solid #ffc107");
        }

        return string.Join("; ", styles);
    }

    private async Task FocusResultsAfterRender()
    {
        await Task.Delay(100); // Small delay to ensure rendering
        try
        {
            await resultsContainer.FocusAsync();
        }
        catch
        {
            // Ignore focus errors
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // If returning from certificates page, auto-select member
        if (SelectMemberNo.HasValue && SelectMemberNo.Value > 0)
        {

            // Find the member by member no
            var member = await DbContext.Members
                .FirstOrDefaultAsync(m => m.MemberNo == SelectMemberNo.Value);

            if (member != null)
            {
                searchResults = new List<Member> { member };

                // Select them (populate form)
                currentMember = member;
                focusedResultIndex = 0;
                isEditing = true;

                //Populate form fields
                editZipCode = member.ZipCode?.ToString() ?? "";
                editZipExt = member.ZipExt?.ToString() ?? "";
                searchLastName = member.LastName ?? "";
                editFirstName = member.FirstName ?? "";
                editMiddleName = member.MiddleName ?? "";
                editAddress1 = member.Address1 ?? "";
                editAddress2 = member.Address2 ?? "";
                editCity = member.City ?? "";
                editState = member.State ?? "";
                editEmail = member.EmailAdr ?? "";
                editAreaCode = member.AreaCode ?? "";
                editPhoneNo = member.PhoneNo ?? "";
                editOrdinDate = member.OrdinDate;
                editSubscrDate = member.SubscrDate;
                editCongrNum1 = member.CongrNum?.ToString() ?? "";
                editCongrNum2 = member.CongrNum2?.ToString() ?? "";
                editForeignAddress = member.ForeignAddress ?? "";
                editSameAdr = member.SameAdr == 1;

                StatusMessage($"Viewing member #{member.MemberNo}", "text-info");
            }
        }
    }
}